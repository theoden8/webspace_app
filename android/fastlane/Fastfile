# Android Fastfile
# This file contains the fastlane.tools configuration for Android

default_platform(:android)

platform :android do
  desc "Runs all the tests"
  lane :test do
    gradle(
      task: "test"
    )
  end

  desc "Build debug APK"
  lane :build_debug do
    gradle(
      task: "assemble",
      flavor: "Fdebug",
      build_type: "Debug"
    )
  end

  desc "Build F-Droid flavor APK"
  lane :build_fdroid do
    gradle(
      task: "assemble",
      flavor: "Fdroid",
      build_type: "Release"
    )
  end

  desc "Build release APK (Fmain flavor)"
  lane :build_release do
    gradle(
      task: "assemble",
      flavor: "Fmain",
      build_type: "Release"
    )
  end


  desc "Build release AAB (Android App Bundle)"
  lane :build_bundle do
    gradle(
      task: "bundle",
      flavor: "Fmain",
      build_type: "Release"
    )
  end

  desc "Build Android app (alias for build_release)"
  lane :build_android do
    build_release
  end

  desc "Increment version in pubspec.yaml"
  lane :bump_version do
    # Version is managed in pubspec.yaml for Flutter projects
    sh("cd ../.. && flutter pub version")
  end

  desc "Build test APKs and generate screenshots"
  lane :screenshots do
    # Build the Fmain flavor APKs for screenshots
    gradle(
      task: "assemble",
      flavor: "Fmain",
      build_type: "Debug"
    )

    # Build the androidTest APK (task format: assemble<Flavor><BuildType>AndroidTest)
    gradle(
      task: "assembleFmainDebugAndroidTest"
    )

    # Get connected device ID
    device_id = sh("adb devices | grep -w 'device' | head -1 | awk '{print $1}'", log: false).strip

    if device_id.empty?
      UI.user_error!("No Android device connected. Please connect a device or start an emulator.")
    end

    UI.success("Found device: #{device_id}")

    # Seed test data using Flutter
    UI.important("Seeding test data on device #{device_id}...")

    # Get project root based on Fastfile location (always android/fastlane/Fastfile)
    # __dir__ gives us the directory containing this Fastfile
    fastfile_dir = File.expand_path(__dir__)
    project_root = File.expand_path("../..", fastfile_dir)
    seeder_path = File.expand_path("test_data_seeder.dart", fastfile_dir)

    UI.message("Fastfile dir: #{fastfile_dir}")
    UI.message("Project root: #{project_root}")
    UI.message("Seeder path: #{seeder_path}")

    # Verify seeder file exists
    unless File.exist?(seeder_path)
      UI.user_error!("Seeder file not found at: #{seeder_path}")
    end

    Dir.chdir(project_root) do
      sh("flutter run -d #{device_id} #{seeder_path}")
    end

    UI.success("Test data seeded successfully")

    # Give the app a moment to save data
    sleep(2)

    # Capture screenshots using Screengrab
    # Trying to use screengrab directly without manual extraction fallback
    screengrab(
      app_package_name: "org.codeberg.theoden8.webspace",
      tests_package_name: "org.codeberg.theoden8.webspace.test",
      use_tests_in_packages: ["org.codeberg.theoden8.webspace"],
      test_instrumentation_runner: "androidx.test.runner.AndroidJUnitRunner",
      locales: ["en-US"],
      clear_previous_screenshots: true,
      output_directory: "fastlane/metadata/android/en-US/images/phoneScreenshots",
      device_type: "phone",
      app_apk_path: "build/app/outputs/flutter-apk/app-fmain-debug.apk",
      tests_apk_path: "build/app/outputs/apk/androidTest/fmain/debug/app-fmain-debug-androidTest.apk"
    )
  end

  desc "Clean build artifacts"
  lane :clean do
    gradle(
      task: "clean"
    )
  end
end
