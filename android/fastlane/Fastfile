# Android Fastfile
# This file contains the fastlane.tools configuration for Android

default_platform(:android)

platform :android do
  desc "Runs all the tests"
  lane :test do
    gradle(task: "test")
  end

  desc "Build debug APK"
  lane :build_debug do
    gradle(
      task: "assemble",
      flavor: "Fdebug",
      build_type: "Debug"
    )
  end

  desc "Build F-Droid flavor APK"
  lane :build_fdroid do
    gradle(
      task: "assemble",
      flavor: "Fdroid",
      build_type: "Release"
    )
  end

  desc "Build release APK (Fmain flavor)"
  lane :build_release do
    gradle(
      task: "assemble",
      flavor: "Fmain",
      build_type: "Release"
    )
  end

  desc "Build release AAB (Android App Bundle)"
  lane :build_bundle do
    gradle(
      task: "bundle",
      flavor: "Fmain",
      build_type: "Release"
    )
  end

  desc "Build Android app (alias for build_release)"
  lane :build_android do
    build_release
  end

  desc "Increment version in pubspec.yaml"
  lane :bump_version do
    # Version is managed in pubspec.yaml for Flutter projects
    sh("cd ../.. && flutter pub version")
  end

  desc "Build test APKs and generate screenshots for F-Droid"
  lane :screenshots do
    # Build the debug APKs for testing
    gradle(
      task: "assemble",
      flavor: "Fdebug",
      build_type: "Debug"
    )

    gradle(
      task: "assembleAndroidTest",
      flavor: "Fdebug",
      build_type: "Debug"
    )

    # Capture screenshots using Screengrab
    screengrab
  end

  desc "Build F-Droid screenshots specifically"
  lane :screenshots_fdroid do
    # Build the fdroid flavor APKs
    gradle(
      task: "assemble",
      flavor: "Fdroid",
      build_type: "Debug"
    )

    gradle(
      task: "assembleAndroidTest",
      flavor: "Fdroid",
      build_type: "Debug"
    )

    # Update Screengrabfile to use fdroid flavor and capture
    screengrab(
      app_apk_path: "app/build/outputs/apk/fdroid/debug/app-fdroid-debug.apk",
      tests_apk_path: "app/build/outputs/apk/androidTest/fdroid/debug/app-fdroid-debug-androidTest.apk"
    )
  end

  desc "Clean build artifacts"
  lane :clean do
    gradle(task: "clean")
  end
end
