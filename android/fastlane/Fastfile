# Android Fastfile
# This file contains the fastlane.tools configuration for Android

default_platform(:android)

platform :android do
  # Helper to get consistent paths regardless of where fastlane is run from
  # This Fastfile is always at android/fastlane/Fastfile
  def android_dir
    File.expand_path("..", __dir__)
  end

  def project_root
    File.expand_path("../..", __dir__)
  end

  desc "Runs all the tests"
  lane :test do
    sh("cd '#{android_dir}' && ./gradlew test")
  end

  desc "Build debug APK"
  lane :build_debug do
    sh("cd '#{project_root}' && fvm flutter build apk --debug --flavor fdebug")
  end

  desc "Build F-Droid flavor APK"
  lane :build_fdroid do
    sh("cd '#{project_root}' && fvm flutter build apk --release --flavor fdroid")
  end

  desc "Build release APK (Fmain flavor)"
  lane :build_release do
    sh("cd '#{project_root}' && fvm flutter build apk --release --flavor fmain")
  end


  desc "Build release AAB (Android App Bundle)"
  lane :build_bundle do
    sh("cd '#{project_root}' && fvm flutter build appbundle --release --flavor fmain")
  end

  desc "Build Android app (alias for build_release)"
  lane :build_android do
    build_release
  end

  desc "Increment version in pubspec.yaml"
  lane :bump_version do
    # Version is managed in pubspec.yaml for Flutter projects
    sh("cd '#{project_root}' && fvm flutter pub version")
  end

  desc "Generate screenshots using Flutter integration test"
  lane :screenshots do
    UI.message("Generating screenshots with Flutter integration test...")
    UI.message("Project root: #{project_root}")

    # Get connected device ID
    device_id = sh("adb devices | grep -w 'device' | head -1 | awk '{print $1}'", log: false).strip

    if device_id.empty?
      UI.user_error!("No Android device connected. Please connect a device or start an emulator.")
    end

    UI.success("Found device: #{device_id}")
    UI.message("Demo data will be seeded by Flutter integration test")

    # Clear previous screenshots
    screenshots_dir = File.join(project_root, "fastlane", "metadata", "android", "en-US", "images", "phoneScreenshots")
    if Dir.exist?(screenshots_dir)
      UI.message("Clearing previous screenshots from #{screenshots_dir}")
      FileUtils.rm_rf(Dir.glob(File.join(screenshots_dir, "*.png")))
    end

    # Run Flutter integration test with screenshot capture
    sh("cd '#{project_root}' && fvm flutter drive \
      --driver=test_driver/integration_test.dart \
      --target=integration_test/screenshot_test.dart \
      --flavor fmain \
      -d #{device_id}")

    UI.success("Screenshots saved to: #{screenshots_dir}")
  end

  desc "Clean build artifacts"
  lane :clean do
    sh("cd '#{android_dir}' && ./gradlew clean")
    sh("cd '#{project_root}' && fvm flutter clean")
  end
end
